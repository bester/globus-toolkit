SHELL	=	/bin/sh
VPATH	=	@srcdir@
srcdir	=	@srcdir@
prefix	=	@prefix@

#
# Set this for the makefile_header below
GLOBUS_INSTALL_PATH	=	@GSI_INSTALL_PATH@

GSI_DEVELOPMENT_PATH	=	@GSI_DEV_PATH@

include $(GSI_DEVELOPMENT_PATH)/etc/makefile_header

MYPROXY_SERVER_DIR	=	@MYPROXY_SERVER_DIR@
MYPROXY_CLIENT_DIR	=	@MYPROXY_CLIENT_DIR@
MYPROXY_TOOLS_DIR	=	@MYPROXY_TOOLS_DIR@

LINK		=	$(CC)

INSTALL		=	$(srcdir)/install-sh
INSTALL_OWNER	=	root

# All of these values come fromthe makefile_header sourced above
GLOBUS_CFLAGS	=	$(INSTALL_INCLUDE) $(BASE_CFLAGS)

DEFS		=	@DEFS@
CFLAGS		=	-g $(DEFS) $(GLOBUS_CFLAGS) $(GLOBUS_GSSAPI_CFLAGS) \
			-DMYPROXY_SERVER_DIR="\"$(MYPROXY_SERVER_DIR)\""

GSI_SOCKET_CFLAGS	=	-DGSI_SOCKET_SSLEAY $(CFLAGS)

SYSLIBS		=	@SYSLIBS@

SERVER_PROGS	=	myproxy-server
CLIENT_PROGS	=	myproxy-init myproxy-destroy
TOOL_PROGS	=	myproxy-get-delegation
TEST_PROGS	=	gsi-socket-test


COMMON_OBJS	= myproxy.o gsi_socket.o gnu_getopt.o gnu_getopt_long.o \
			verror.o ssl_utils.o
CLIENT_OBJS	= myproxy_read_pass.o
INIT_OBJS	= myproxy_init.o $(COMMON_OBJS) $(CLIENT_OBJS)
DESTROY_OBJS	= myproxy_destroy.o $(COMMON_OBJS) $(CLIENT_OBJS)
GET_OBJS	= myproxy_get_delegation.o $(COMMON_OBJS) $(CLIENT_OBJS)
SERVER_OBJS	= myproxy_server.o myproxy_creds.o \
			myproxy_log.o vparse.o myproxy_server_config.o \
			$(COMMON_OBJS)

default:	clients server tools

clients:	$(CLIENT_PROGS)

server:		$(SERVER_PROGS)

tools:		$(TOOL_PROGS)

gsi-socket-test: gsi_socket_test.o gsi_socket.o
	$(LINK) $(LDFLAGS) $(GLOBUS_GSSAPI_LDFLAGS) \
		-o $@ gsi_socket_test.o gsi_socket.o $(GLOBUS_GSSAPI_LIBS) \
		$(SYSLIBS)

ssl_test: ssl_test.o ssl_utils.o verror.o
	$(CC) -g $(LDFLAGS) $(GLOBUS_GSSAPI_LDFLAGS) \
		-o $@ ssl_test.o ssl_utils.o verror.o \
		$(GLOBUS_GSSAPI_LIBS) $(SYSLIBS)

gsi_socket.o: gsi_socket.c
	$(CC) $(GSI_SOCKET_CFLAGS) -c $<

myproxy-init: $(INIT_OBJS)
	$(LINK) $(LDFLAGS) $(GLOBUS_GSSAPI_LDFLAGS) \
		-o $@ $(INIT_OBJS) $(GLOBUS_GSSAPI_LIBS) $(SYSLIBS)

myproxy-destroy: $(DESTROY_OBJS)
	$(CC) $(LDFLAGS) $(GLOBUS_GSSAPI_LDFLAGS) \
		-o $@ $(DESTROY_OBJS) $(GLOBUS_GSSAPI_LIBS) $(SYSLIBS)

myproxy-get-delegation: $(GET_OBJS)
	$(CC) $(LDFLAGS) $(GLOBUS_GSSAPI_LDFLAGS) \
		-o $@ $(GET_OBJS) $(GLOBUS_GSSAPI_LIBS) $(SYSLIBS)

myproxy-server: $(SERVER_OBJS)
	$(CC) $(LDFLAGS) $(GLOBUS_GSSAPI_LDFLAGS) \
		-o $@ $(SERVER_OBJS) $(GLOBUS_GSSAPI_LIBS) $(SYSLIBS)

myproxy.o: myproxy.c myproxy.h

myproxy_creds.o: myproxy_creds.c myproxy_creds.h

gnu_getopt.o: gnu_getopt.c

gnu_getopt_long.o: gnu_getopt_long.c

depend:
	makedepend $(CFLAGS) *.c

etags:
	etags *.c

clean:
	rm -f *.o *~
	rm -f $(SERVER_PROGS) $(CLIENT_PROGS) $(TOOL_PROGS) $(TEST_PROGS)

distclean:	clean
	rm -f Makefile config.cache config.log config.status

install:	server-install client-install tools-install

server-install:	$(SERVER_PROGS)
	@for prog in $(SERVER_PROGS) ; do \
	  echo Installing $${prog} in $(MYPROXY_SERVER_DIR)/sbin ; \
	  $(INSTALL) -o $(INSTALL_OWNER) -m 755 $${prog} $(MYPROXY_SERVER_DIR)/sbin/$${prog} ;\
	done
	@if test ! -f $(MYPROXY_SERVER_DIR)/etc/myproxy-server.config ; then \
	  echo Copying base server configuration file to $(MYPROXY_SERVER_DIR)/etc/myproxy-server.config ;\
	  $(INSTALL) -o $(INSTALL_OWNER) -m 644 -c ${srcdir}/myproxy-server.config $(MYPROXY_SERVER_DIR)/etc/myproxy-server.config ;\
	fi
	@if test ! -d $(MYPROXY_SERVER_DIR)/store ; then \
	  echo Creating credentials storage directory $(MYPROXY_SERVER_DIR)/store ;\
	  $(INSTALL) -o $(INSTALL_OWNER) -m 700 -d $(MYPROXY_SERVER_DIR)/store ;\
	fi

client-install: $(CLIENT_PROGS)
	@for prog in $(CLIENT_PROGS) ; do \
	  echo Installing $${prog} in $(MYPROXY_CLIENT_DIR)/bin ; \
	  $(INSTALL) -o $(INSTALL_OWNER) -m 755 $${prog} $(MYPROXY_CLIENT_DIR)/bin/$${prog} ;	\
	done

tools-install: $(TOOL_PROGS)
	@for prog in $(TOOL_PROGS) ; do \
	  echo Installing $${prog} in $(MYPROXY_TOOLS_DIR)/bin ; \
	  $(INSTALL) -o $(INSTALL_OWNER) -m 755 $${prog} $(MYPROXY_TOOLS_DIR)/bin/$${prog} ;	\
	done

