SHELL	=	/bin/sh
VPATH	=	@srcdir@
srcdir	=	@srcdir@
prefix	=	@prefix@

include @GLOBUS_MAKEFILE_HEADER@

MYPROXY_SERVER_DIR	=	@MYPROXY_SERVER_DIR@
MYPROXY_SERVER_ETC_DIR	=	@MYPROXY_SERVER_ETC_DIR@
MYPROXY_SERVER_STORE_DIR=	@MYPROXY_SERVER_STORE_DIR@
MYPROXY_CLIENT_DIR	=	@MYPROXY_CLIENT_DIR@
MYPROXY_TOOLS_DIR	=	@MYPROXY_TOOLS_DIR@

LINK		=	$(CC)

INSTALL		=	$(srcdir)/install-sh

# All of these values come fromthe makefile_header sourced above
GLOBUS_CFLAGS	=	$(INSTALL_INCLUDE) $(GLOBUS_INCLUDES) $(BASE_CFLAGS)

DEFS		=	@DEFS@
CFLAGS		=	-g $(DEFS) $(GLOBUS_CFLAGS) $(GLOBUS_GSSAPI_CFLAGS) \
		-DMYPROXY_SERVER_ETC_DIR="\"$(MYPROXY_SERVER_ETC_DIR)\""\
		-DMYPROXY_SERVER_STORE_DIR="\"$(MYPROXY_SERVER_STORE_DIR)\""
LDFLAGS		=	-Wl,-rpath -Wl,@GLOBUS_LIB_DIR@

GSI_SOCKET_CFLAGS	=	-DGSI_SOCKET_SSLEAY $(CFLAGS)

SYSLIBS		=	@SYSLIBS@

SERVER_PROGS	=	myproxy-server
CLIENT_PROGS	=	myproxy-init myproxy-destroy myproxy-info
TOOL_PROGS	=	myproxy-get-delegation
TEST_PROGS	=	gsi-socket-test
MYPROXY_LIB     =       libmyproxy.a
MYPROXY_HEADERS =       myproxy.h myproxy_delegation.h gsi_socket.h myproxy_authorization.h myproxy_creds.h version.h verror.h


LIB_OBJS	= myproxy.o gsi_socket.o gnu_getopt.o gnu_getopt_long.o \
			verror.o ssl_utils.o string_funcs.o \
			myproxy_delegation.o myproxy_read_pass.o \
			gsi_proxy.o myproxy_authorization.o myproxy_log.o 
INIT_OBJS	= myproxy_init.o $(MYPROXY_LIB)
DESTROY_OBJS	= myproxy_destroy.o $(MYPROXY_LIB)
INFO_OBJS	= myproxy_info.o $(MYPROXY_LIB)
GET_OBJS	= myproxy_get_delegation.o $(MYPROXY_LIB)
SERVER_OBJS	= myproxy_server.o myproxy_creds.o \
			vparse.o myproxy_server_config.o \
			$(MYPROXY_LIB)

default:	clients server tools library

clients:	$(CLIENT_PROGS)

server:		$(SERVER_PROGS)

tools:		$(TOOL_PROGS)

library:	$(MYPROXY_LIB)

gsi-socket-test: gsi_socket_test.o gsi_socket.o
	$(LINK) $(LDFLAGS) $(GLOBUS_LDFLAGS) $(GLOBUS_GSSAPI_LDFLAGS) \
		-o $@ gsi_socket_test.o gsi_socket.o $(GLOBUS_PKG_LIBS) \
		$(GLOBUS_GSSAPI_LIBS) $(SYSLIBS)

ssl_test: ssl_test.o ssl_utils.o verror.o
	$(LINK) -g $(LDFLAGS) $(GLOBUS_LDFLAGS) $(GLOBUS_GSSAPI_LDFLAGS) \
		-o $@ ssl_test.o ssl_utils.o verror.o \
		$(GLOBUS_PKG_LIBS) $(GLOBUS_GSSAPI_LIBS) $(SYSLIBS)

gsi_socket.o: gsi_socket.c
	$(CC) $(GSI_SOCKET_CFLAGS) -c $<

myproxy-init: $(INIT_OBJS)
	$(LINK) $(LDFLAGS) $(GLOBUS_LDFLAGS) $(GLOBUS_GSSAPI_LDFLAGS) \
		-o $@ $(INIT_OBJS) $(GLOBUS_PKG_LIBS) $(GLOBUS_GSSAPI_LIBS) \
		$(SYSLIBS)

myproxy-destroy: $(DESTROY_OBJS)
	$(LINK) $(LDFLAGS) $(GLOBUS_LDFLAGS) $(GLOBUS_GSSAPI_LDFLAGS) \
		-o $@ $(DESTROY_OBJS) $(GLOBUS_PKG_LIBS) \
		$(GLOBUS_GSSAPI_LIBS) $(SYSLIBS)

myproxy-info: $(INFO_OBJS)
	$(LINK) $(LDFLAGS) $(GLOBUS_LDFLAGS) $(GLOBUS_GSSAPI_LDFLAGS) \
		-o $@ $(INFO_OBJS) $(GLOBUS_PKG_LIBS) \
		$(GLOBUS_GSSAPI_LIBS) $(SYSLIBS)

myproxy-get-delegation: $(GET_OBJS)
	$(LINK) $(LDFLAGS) $(GLOBUS_LDFLAGS) $(GLOBUS_GSSAPI_LDFLAGS) \
		-o $@ $(GET_OBJS) $(GLOBUS_PKG_LIBS) \
		$(GLOBUS_GSSAPI_LIBS) $(SYSLIBS)

myproxy-server: $(SERVER_OBJS)
	$(LINK) $(LDFLAGS) $(GLOBUS_LDFLAGS) $(GLOBUS_GSSAPI_LDFLAGS) \
		-o $@ $(SERVER_OBJS) $(GLOBUS_PKG_LIBS) \
		$(GLOBUS_GSSAPI_LIBS) $(SYSLIBS)

libmyproxy.a: $(LIB_OBJS)
	$(AR) rsc $@ $^

myproxy.o: myproxy.c myproxy.h

myproxy_creds.o: myproxy_creds.c myproxy_creds.h

gnu_getopt.o: gnu_getopt.c

gnu_getopt_long.o: gnu_getopt_long.c

depend:
	makedepend $(CFLAGS) *.c

etags:
	etags *.c

clean:
	rm -f *.o *~
	rm -f $(SERVER_PROGS) $(CLIENT_PROGS) $(TOOL_PROGS) $(TEST_PROGS) $(MYPROXY_LIB)

distclean:	clean
	rm -f Makefile config.cache config.log config.status myproxy.cron

install:	server-install client-install tools-install library-install

server-install:	$(SERVER_PROGS)
	@for prog in $(SERVER_PROGS) ; do \
	  echo Installing $${prog} in $(MYPROXY_SERVER_DIR)/sbin ; \
	  $(INSTALL) -m 755 -c $${prog} $(MYPROXY_SERVER_DIR)/sbin/$${prog} ;\
	done
	@if test ! -f $(MYPROXY_SERVER_ETC_DIR)/myproxy-server.config ; then \
	  echo Copying base server configuration file to $(MYPROXY_SERVER_ETC_DIR)/myproxy-server.config ;\
	  $(INSTALL) -m 644 -c ${srcdir}/myproxy-server.config $(MYPROXY_SERVER_ETC_DIR)/myproxy-server.config ;\
	fi
	@if test ! -f $(MYPROXY_SERVER_ETC_DIR)/myproxy.cron ; then \
          echo Copying myproxy cron script to $(MYPROXY_SERVER_ETC_DIR)/myproxy.cron ;\
          $(INSTALL) -m 755 -c ${srcdir}/myproxy.cron $(MYPROXY_SERVER_ETC_DIR)/myproxy.cron ;\
        fi
	@if test ! -d $(MYPROXY_SERVER_STORE_DIR) ; then \
	  echo Creating credentials storage directory $(MYPROXY_SERVER_STORE_DIR) ;\
	  $(INSTALL) -m 700 -d $(MYPROXY_SERVER_STORE_DIR) ;\
	fi

client-install: $(CLIENT_PROGS)
	@for prog in $(CLIENT_PROGS) ; do \
	  echo Installing $${prog} in $(MYPROXY_CLIENT_DIR)/bin ; \
	  $(INSTALL) -m 755 -c $${prog} $(MYPROXY_CLIENT_DIR)/bin/$${prog} ;	\
	done

tools-install: $(TOOL_PROGS)
	@for prog in $(TOOL_PROGS) ; do \
	  echo Installing $${prog} in $(MYPROXY_TOOLS_DIR)/bin ; \
	  $(INSTALL) -m 755 -c $${prog} $(MYPROXY_TOOLS_DIR)/bin/$${prog} ;	\
	done

library-install: $(MYPROXY_LIB)
	echo Installing $(MYPROXY_LIB) in $(MYPROXY_TOOLS_DIR)/lib
	$(INSTALL) -m 755 -c $(MYPROXY_LIB) $(MYPROXY_TOOLS_DIR)/lib/libmyproxy.a
	echo Installing headers in $(MYPROXY_TOOLS_DIR)/include
	@if test ! -d $(MYPROXY_TOOLS_DIR)/include ; then \
	  echo Creating directory $(MYPROXY_TOOLS_DIR)/include ;\
	  $(INSTALL) -m 755 -d $(MYPROXY_TOOLS_DIR)/include ;\
	fi

	@for header in $(MYPROXY_HEADERS); do \
	  $(INSTALL) -m 755 -c $${header} $(MYPROXY_TOOLS_DIR)/include; \
	done
