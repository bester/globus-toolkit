SHELL	=	/bin/sh
VPATH	=	@srcdir@
srcdir	=	@srcdir@

#
# Set this for the makefile_header below
GLOBUS_INSTALL_PATH	=	@GLOBUS_INSTALL_PATH@

GSI_DEVELOPMENT_PATH	=	@GLOBUS_DEV_PATH@

include $(GSI_DEVELOPMENT_PATH)/etc/makefile_header

MYPROXY_SERVER_DIR	=	@MYPROXY_SERVER_DIR@
MYPROXY_CLIENT_DIR	=	@MYPROXY_CLIENT_DIR@
MYPROXY_TOOLS_DIR	=	@MYPROXY_TOOLS_DIR@

LINK		=	$(CC)

INSTALL		=	$(srcdir)/install-sh
INSTALL_OWNER	=	root

GLOBUS_CFLAGS	=	$(INSTALL_INCLUDE)
DEFS		=	@DEFS@
CFLAGS		=	-g -Wall $(DEFS) $(GLOBUS_CFLAGS) \
			-DMYPROXY_SERVER_DIR="\"$(MYPROXY_SERVER_DIR)\""

GSI_SOCKET_CFLAGS	=	-DGSI_SOCKET_SSLEAY $(CFLAGS)
####

SERVER_PROGS	=	myproxy-server
CLIENT_PROGS	=	myproxy-init myproxy-destroy
TOOL_PROGS	=	myproxy-get-delegation
TEST_PROGS	=	gsi-socket-test


COMMON_OBJS	= myproxy.o gsi_socket.o gnu_getopt.o gnu_getopt_long.o verror.o
INIT_OBJS	= myproxy_init.o $(COMMON_OBJS)
DESTROY_OBJS	= myproxy_destroy.o $(COMMON_OBJS) 
GET_OBJS	= myproxy_get_delegation.o $(COMMON_OBJS)
SERVER_OBJS	= myproxy_server.o myproxy_creds.o \
			myproxy_log.o vparse.o myproxy_server_config.o \
			$(COMMON_OBJS)

default:	clients server tools

clients:	$(CLIENT_PROGS)

server:		$(SERVER_PROGS)

tools:		$(TOOL_PROGS)

gsi-socket-test: gsi_socket_test.o gsi_socket.o
	$(LINK) $(LDFLAGS) $(GLOBUS_GSSAPI_LDFLAGS) \
		-o $@ $^ $(GLOBUS_GSSAPI_LIBS)

gsi_socket.o: gsi_socket.c
	$(CC) $(GSI_SOCKET_CFLAGS) -c $<

myproxy-init: $(INIT_OBJS)
	$(LINK) $(LDFLAGS) $(GLOBUS_GSSAPI_LDFLAGS) \
		-o $@ $^ $(GLOBUS_GSSAPI_LIBS)

myproxy-destroy: $(DESTROY_OBJS)
	$(CC) $(LDFLAGS) $(GLOBUS_GSSAPI_LDFLAGS) \
		-o $@ $^ $(GLOBUS_GSSAPI_LIBS)

myproxy-get-delegation: $(GET_OBJS)
	$(CC) $(LDFLAGS) $(GLOBUS_GSSAPI_LDFLAGS) \
		-o $@ $^ $(GLOBUS_GSSAPI_LIBS)

myproxy-server: $(SERVER_OBJS)
	$(CC) $(LDFLAGS) $(GLOBUS_GSSAPI_LDFLAGS) \
		-o $@ $^ $(GLOBUS_GSSAPI_LIBS)

myproxy.o: myproxy.c myproxy.h

myproxy_creds.o: myproxy_creds.c myproxy_creds.h

gnu_getopt.o: gnu_getopt.c

gnu_getopt_long.o: gnu_getopt_long.c

clean:
	rm -f *.o *~
	rm -f $(TARGETS)

distclean:	clean
	rm -f Makefile config.cache config.log config.status

install:	server-install client-install tools-install

server-install:	$(SERVER_PROGS)
	@for prog in $(SERVER_PROGS) ; do \
	  echo Installing $${prog} in $(MYPROXY_SERVER_DIR)/sbin ; \
	  $(INSTALL) -o $(INSTALL_OWNER) -m 755 $${prog} $(MYPROXY_SERVER_DIR)/sbin/$${prog} ;\
	done
	@if test ! -f $(MYPROXY_SERVER_DIR)/etc/myproxy-server.config ; then \
	  echo Copy base server configuration file to $(MYPROXY_SERVER_DIR)/etc/myproxy-server.config ;\
	  $(INSTALL) -o $(INSTALL_OWNER) -m 644 -c myproxy-server.config $(MYPROXY_SERVER_DIR)/etc/myproxy-server.config ;\
	fi
	@if test ! -d $(MYPROXY_SERVER_DIR)/store ; then \
	  echo Creating credentials storage directory $(MYPROXY_SERVER_DIR)/store ;\
	  $(INSTALL) -o $(INSTALL_OWNER) -m 700 -d $(MYPROXY_SERVER_DIR)/store ;\
	fi

client-install: $(CLIENT_PROGS)
	@for prog in $(CLIENT_PROGS) ; do \
	  echo Installing $${prog} in $(MYPROXY_CLIENT_DIR)/bin ; \
	  $(INSTALL) -o $(INSTALL_OWNER) -m 755 $${prog} $(MYPROXY_CLIENT_DIR)/bin ;	\
	done

tools-install: $(TOOL_PROGS)
	@for prog in $(TOOL_PROGS) ; do \
	  echo Installing $${prog} in $(MYPROXY_TOOLS_DIR)/bin ; \
	  $(INSTALL) -o $(INSTALL_OWNER) -m 755 $${prog} $(MYPROXY_TOOLS_DIR)/bin ;	\
	done

